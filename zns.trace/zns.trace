#! /bin/bash

# TODO: clean this up to some global python script to do all this


set -e

if [[ "$#" -ne "1" ]]; then echo "Requires ZNS device name (e.g. nvme2n2) argument" && exit; fi

DEV=$1

if [[ "$(cat /sys/block/$DEV/queue/zoned)" != "host-managed" ]]; then
    echo "${DEV} is not a zoned device."
    exit 1
fi

ZONE_SIZE=$(sudo env "PATH=${PATH}" nvme zns report-zones /dev/${DEV} -d 2 | tail -n1 | grep -o 'SLBA:.*$' | awk '{print strtonum($2)}')
NR_ZONES=$(sudo env "PATH=$PATH" nvme zns report-zones /dev/${DEV} -d 1 | grep 'nr_zones' | awk '{print $2}')

mkdir -p data

echo "Tracing ${DEV}"
echo "Hit Ctrl-C or send INT to stop trace and generate plots"

# TODO: we want a new dir for each trace, use this in the generation
DATA_FILE=${DEV}-$(date +"%Y_%m_%d_%I_%M_%p").dat

# TODO: tracetime we need to replace interval in each bpftrace file with sed
TRACETIME=3

# TODO: lookup bpftrace install path and use it
# TODO: we could drop zns probes if zns-bio-probes collects the same in different format (will need a rewrite of the heatmap generation - so for now leaving it)
# echo "Inserting ZNS Probes"
# (sudo /home/user/src/bpftrace/build/src/bpftrace ./zns-probes.bt ${DEV} ${ZONE_SIZE} -o data/zns_data.json) &
echo "Inserting ZNS-Bio Probes"
# TODO: set the block size of the device (pass as arg probably)
(sudo /home/user/src/bpftrace/build/src/bpftrace ./zns-bio-probes.bt ${DEV} ${ZONE_SIZE} -o data/zns_bio_data.json) &
echo "Inserting VFS Probes"
(sudo /home/user/src/bpftrace/build/src/bpftrace ./vfs-probes.bt -o data/vfs_data.json -f json) &
echo "Inserting F2FS Probes"
(sudo /home/user/src/bpftrace/build/src/bpftrace -I include/f2fs.h ./f2fs-probes.bt -o data/f2fs_data.json -f json) &

wait

read -rep "Input comments to embed in data file (Enter for none): " COMMENTS

# Place the comments in the data file // TODO: this is broken somehow?
sed -i "1s/^/${COMMENTS}\n/" data/${DATA_FILE}

mkdir -p figs/${DATA_FILE}

printf "# Comments\n\n" >> figs/${DATA_FILE}/README.md
printf "${COMMENTS}\n" >> figs/${DATA_FILE}/README.md

echo "Stopping ${DEV} tracing"
# echo "Generating figures"

# python3 plot.py -s ${ZONE_SIZE} -z ${NR_ZONES}
